/* http://www.nw-fva.de
   Version 07-11-2008

   (c) 2002 Juergen Nagel, Northwest German Forest Research Station, 
       Grätzelstr.2, 37079 Göttingen, Germany
       E-Mail: Juergen.Nagel@nw-fva.de
 
This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation.

This program is distributed in the hope that it will be useful,
but WITHOUT  WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.
 */
package forestsimulator.standsimulation;
import java.awt.Frame;
import treegross.base.*;
import org.jdom.Document;
import org.jdom.Element;
import org.jdom.ProcessingInstruction;
import org.jdom.output.XMLOutputter;
import org.jdom.input.*;
import java.io.*;
import java.text.NumberFormat;
import java.util.*;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.DefaultListModel;
import org.jdom.JDOMException;
import org.jdom.output.Format;
import treegross.base.thinning.HeightBasedThinning;


/**
 *
 * @author  nagel
 */
public class TgSpeciesManXML extends javax.swing.JDialog {
    
    private static final Logger logger = Logger.getLogger(TgSpeciesManXML.class.getName());
    private final List<SpeciesDef> spd = new ArrayList<>();
    private int nspd = 0;
    private static Element rootElt;
    private final DefaultListModel listModel = new DefaultListModel();
    private final File urlname;
    
    public TgSpeciesManXML(Frame parent, boolean modal, File workdir, String fn) {
        super(parent, modal);
        initComponents();
        urlname = new File(new File(workdir, "models"), fn);
        loadXMLFile();
        if (!spd.isEmpty()) {
          loadTable(spd.get(0));
          speciesList.setSelectedIndex(0);
        }
    }
    
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel4 = new javax.swing.JPanel();
        jPanel6 = new javax.swing.JPanel();
        generalSettingsLabel = new javax.swing.JLabel();
        modelRegionLabel = new javax.swing.JLabel();
        modelRegionTextField = new javax.swing.JTextField();
        randomnessCheckBox = new javax.swing.JCheckBox();
        ingrowthCheckBox = new javax.swing.JCheckBox();
        deadWoodModuleCheckBox = new javax.swing.JCheckBox();
        timeStepLabel = new javax.swing.JLabel();
        timeStepTextField = new javax.swing.JTextField();
        jPanel7 = new javax.swing.JPanel();
        jPanel8 = new javax.swing.JPanel();
        authorTextField = new javax.swing.JTextField();
        dateLabel = new javax.swing.JLabel();
        dateTextField = new javax.swing.JTextField();
        lastUpdateLabel = new javax.swing.JLabel();
        lastUpdateTextField = new javax.swing.JTextField();
        jScrollPane4 = new javax.swing.JScrollPane();
        descriptionTextArea = new javax.swing.JTextArea();
        literatureTextField = new javax.swing.JTextField();
        jPanel9 = new javax.swing.JPanel();
        sortingModuleLabel = new javax.swing.JLabel();
        sortingModuleTextField = new javax.swing.JTextField();
        biomassLabel = new javax.swing.JLabel();
        biomassTextField = new javax.swing.JTextField();
        deadWoodModuleLabel = new javax.swing.JLabel();
        deadWoodModuleTextField = new javax.swing.JTextField();
        jScrollPane3 = new javax.swing.JScrollPane();
        jPanel1 = new javax.swing.JPanel();
        selectedSpeciesLabel = new javax.swing.JLabel();
        jPanel5 = new javax.swing.JPanel();
        jScrollPane2 = new javax.swing.JScrollPane();
        jTable1 = new javax.swing.JTable();
        jPanel3 = new javax.swing.JPanel();
        saveButton = new javax.swing.JButton();
        saveAsNewButton = new javax.swing.JButton();
        saveSettingsButton = new javax.swing.JButton();
        deleteButton = new javax.swing.JButton();
        jPanel2 = new javax.swing.JPanel();
        treeSpeciesLabel = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        speciesList = new javax.swing.JList();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        java.util.ResourceBundle bundle = java.util.ResourceBundle.getBundle("forestsimulator/gui"); // NOI18N
        setTitle(bundle.getString("TgSpeciesManXML.title")); // NOI18N
        setBackground(java.awt.Color.white);

        jPanel4.setLayout(new java.awt.BorderLayout());

        jPanel6.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT));

        generalSettingsLabel.setText(bundle.getString("TgSpeciesManXML.generalSettingsLabel.text")); // NOI18N
        jPanel6.add(generalSettingsLabel);

        modelRegionLabel.setText(bundle.getString("TgSpeciesManXML.modelRegionLabel.text")); // NOI18N
        jPanel6.add(modelRegionLabel);

        modelRegionTextField.setText(bundle.getString("TgSpeciesManXML.modelRegionTextField.text")); // NOI18N
        modelRegionTextField.setPreferredSize(new java.awt.Dimension(259, 20));
        jPanel6.add(modelRegionTextField);

        randomnessCheckBox.setSelected(true);
        randomnessCheckBox.setText(bundle.getString("TgSpeciesManXML.randomnessCheckBox.text")); // NOI18N
        jPanel6.add(randomnessCheckBox);

        ingrowthCheckBox.setText(bundle.getString("TgSpeciesManXML.ingrowthCheckBox.text")); // NOI18N
        jPanel6.add(ingrowthCheckBox);

        deadWoodModuleCheckBox.setText(bundle.getString("TgSpeciesManXML.deadWoodModuleCheckBox.text")); // NOI18N
        jPanel6.add(deadWoodModuleCheckBox);

        timeStepLabel.setText(bundle.getString("TgSpeciesManXML.timeStepLabel.text")); // NOI18N
        jPanel6.add(timeStepLabel);

        timeStepTextField.setText(bundle.getString("TgSpeciesManXML.timeStepTextField.text")); // NOI18N
        timeStepTextField.setPreferredSize(new java.awt.Dimension(22, 20));
        jPanel6.add(timeStepTextField);

        jPanel4.add(jPanel6, java.awt.BorderLayout.NORTH);

        jPanel7.setLayout(new java.awt.BorderLayout());

        jPanel8.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT));

        authorTextField.setText(bundle.getString("TgSpeciesManXML.authorTextField.text")); // NOI18N
        authorTextField.setToolTipText(bundle.getString("TgSpeciesManXML.authorTextField.toolTipText")); // NOI18N
        authorTextField.setPreferredSize(new java.awt.Dimension(232, 20));
        jPanel8.add(authorTextField);

        dateLabel.setText(bundle.getString("TgSpeciesManXML.dateLabel.text")); // NOI18N
        jPanel8.add(dateLabel);

        dateTextField.setText(bundle.getString("TgSpeciesManXML.dateTextField.text")); // NOI18N
        dateTextField.setPreferredSize(new java.awt.Dimension(80, 20));
        jPanel8.add(dateTextField);

        lastUpdateLabel.setText(bundle.getString("TgSpeciesManXML.lastUpdateLabel.text")); // NOI18N
        lastUpdateLabel.setToolTipText(bundle.getString("TgSpeciesManXML.lastUpdateLabel.toolTipText")); // NOI18N
        jPanel8.add(lastUpdateLabel);

        lastUpdateTextField.setText(bundle.getString("TgSpeciesManXML.lastUpdateTextField.text")); // NOI18N
        lastUpdateTextField.setPreferredSize(new java.awt.Dimension(80, 20));
        jPanel8.add(lastUpdateTextField);

        jPanel7.add(jPanel8, java.awt.BorderLayout.NORTH);

        descriptionTextArea.setColumns(20);
        descriptionTextArea.setRows(5);
        descriptionTextArea.setToolTipText(bundle.getString("TgSpeciesManXML.descriptionTextArea.toolTipText")); // NOI18N
        descriptionTextArea.setPreferredSize(new java.awt.Dimension(164, 74));
        jScrollPane4.setViewportView(descriptionTextArea);

        jPanel7.add(jScrollPane4, java.awt.BorderLayout.CENTER);

        literatureTextField.setText(bundle.getString("TgSpeciesManXML.literatureTextField.text")); // NOI18N
        literatureTextField.setToolTipText(bundle.getString("TgSpeciesManXML.literatureTextField.toolTipText")); // NOI18N
        jPanel7.add(literatureTextField, java.awt.BorderLayout.PAGE_END);

        jPanel4.add(jPanel7, java.awt.BorderLayout.CENTER);

        jPanel9.setLayout(new java.awt.GridLayout(1, 6));

        sortingModuleLabel.setText(bundle.getString("TgSpeciesManXML.sortingModuleLabel.text")); // NOI18N
        jPanel9.add(sortingModuleLabel);

        sortingModuleTextField.setText(bundle.getString("TgSpeciesManXML.sortingModuleTextField.text")); // NOI18N
        jPanel9.add(sortingModuleTextField);

        biomassLabel.setText(bundle.getString("TgSpeciesManXML.biomassLabel.text")); // NOI18N
        jPanel9.add(biomassLabel);

        biomassTextField.setText(bundle.getString("TgSpeciesManXML.biomassTextField.text")); // NOI18N
        jPanel9.add(biomassTextField);

        deadWoodModuleLabel.setText(bundle.getString("TgSpeciesManXML.deadWoodModuleLabel.text")); // NOI18N
        jPanel9.add(deadWoodModuleLabel);

        deadWoodModuleTextField.setText(bundle.getString("TgSpeciesManXML.deadWoodModuleTextField.text")); // NOI18N
        jPanel9.add(deadWoodModuleTextField);

        jPanel4.add(jPanel9, java.awt.BorderLayout.SOUTH);

        getContentPane().add(jPanel4, java.awt.BorderLayout.NORTH);

        jPanel1.setLayout(new java.awt.BorderLayout());

        selectedSpeciesLabel.setText(bundle.getString("TgSpeciesManXML.selectedSpeciesLabel.text")); // NOI18N
        jPanel1.add(selectedSpeciesLabel, java.awt.BorderLayout.PAGE_START);

        jPanel5.setLayout(new java.awt.BorderLayout());

        jScrollPane2.setAutoscrolls(true);

        jTable1.setFont(new java.awt.Font("Arial", 0, 12)); // NOI18N
        jTable1.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null},
                {null, null}
            },
            new String [] {
                "Variable", "XML Code"
            }
        ));
        jScrollPane2.setViewportView(jTable1);

        jPanel5.add(jScrollPane2, java.awt.BorderLayout.CENTER);

        jPanel1.add(jPanel5, java.awt.BorderLayout.CENTER);

        saveButton.setText(bundle.getString("TgSpeciesManXML.saveButton.text")); // NOI18N
        saveButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                saveButtonActionPerformed(evt);
            }
        });

        saveAsNewButton.setText(bundle.getString("TgSpeciesManXML.saveAsNewButton.text")); // NOI18N
        saveAsNewButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                saveAsNewButtonActionPerformed(evt);
            }
        });

        saveSettingsButton.setText(bundle.getString("TgSpeciesManXML.saveSettingsButton.text")); // NOI18N
        saveSettingsButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                saveSettingsButtonActionPerformed(evt);
            }
        });

        deleteButton.setText(bundle.getString("TgSpeciesManXML.deleteButton.text")); // NOI18N
        deleteButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                deleteButtonActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addGap(28, 28, 28)
                .addComponent(saveButton)
                .addGap(15, 15, 15)
                .addComponent(saveAsNewButton)
                .addGap(21, 21, 21)
                .addComponent(deleteButton)
                .addGap(16, 16, 16)
                .addComponent(saveSettingsButton)
                .addContainerGap(625, Short.MAX_VALUE))
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(saveSettingsButton)
                    .addComponent(saveButton)
                    .addComponent(saveAsNewButton)
                    .addComponent(deleteButton))
                .addGap(37, 37, 37))
        );

        jPanel1.add(jPanel3, java.awt.BorderLayout.SOUTH);

        jScrollPane3.setViewportView(jPanel1);

        getContentPane().add(jScrollPane3, java.awt.BorderLayout.CENTER);

        jPanel2.setPreferredSize(new java.awt.Dimension(100, 600));
        jPanel2.setLayout(new java.awt.BorderLayout());

        treeSpeciesLabel.setText(bundle.getString("TgSpeciesManXML.treeSpeciesLabel.text")); // NOI18N
        jPanel2.add(treeSpeciesLabel, java.awt.BorderLayout.NORTH);

        speciesList.setModel(listModel);
        speciesList.addListSelectionListener(new javax.swing.event.ListSelectionListener() {
            public void valueChanged(javax.swing.event.ListSelectionEvent evt) {
                speciesListValueChanged(evt);
            }
        });
        jScrollPane1.setViewportView(speciesList);

        jPanel2.add(jScrollPane1, java.awt.BorderLayout.CENTER);

        getContentPane().add(jPanel2, java.awt.BorderLayout.WEST);

        setSize(new java.awt.Dimension(1196, 820));
        setLocationRelativeTo(null);
    }// </editor-fold>//GEN-END:initComponents

    private void deleteButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_deleteButtonActionPerformed
        int m = speciesList.getSelectedIndex();
        spd.remove(m);
    }//GEN-LAST:event_deleteButtonActionPerformed

    private void saveButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_saveButtonActionPerformed
       int m = speciesList.getSelectedIndex(); //get SelectedIndex from List
       saveTable(spd.get(m));
    }//GEN-LAST:event_saveButtonActionPerformed

    private void speciesListValueChanged(javax.swing.event.ListSelectionEvent evt) {//GEN-FIRST:event_speciesListValueChanged
       int m = speciesList.getSelectedIndex(); //get SelectedIndex from List
       loadTable(spd.get(m));

    }//GEN-LAST:event_speciesListValueChanged

    private void saveSettingsButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_saveSettingsButtonActionPerformed
        saveXMLFile();
        dispose();
    }//GEN-LAST:event_saveSettingsButtonActionPerformed

    private void saveAsNewButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_saveAsNewButtonActionPerformed
        SpeciesDef speciesDefinition = new SpeciesDef();
        saveTable(speciesDefinition);
        spd.add(speciesDefinition);
       
        renewList();
    }//GEN-LAST:event_saveAsNewButtonActionPerformed

    private void renewList(){
        listModel.removeAllElements();
        listModel.clear();
        for (SpeciesDef speciesDef : spd) {
            listModel.addElement(speciesDef.shortName);
        }
    }
    
    private void saveTable(SpeciesDef speciesDefinition){
        SpeciesDefMap sdm = new SpeciesDefMap();
        speciesDefinition.code = Integer.parseInt((String) jTable1.getValueAt(0,1));
        speciesDefinition.shortName=(String) jTable1.getValueAt(1,1);
        speciesDefinition.longName=(String) jTable1.getValueAt(2,1);
        speciesDefinition.latinName=(String) jTable1.getValueAt(3,1);
        speciesDefinition.internalCode = Integer.parseInt((String) jTable1.getValueAt(4,1));
        speciesDefinition.codeGroup = Integer.parseInt((String) jTable1.getValueAt(5,1));
        speciesDefinition.handledLikeCode = Integer.parseInt((String) jTable1.getValueAt(6,1));
        speciesDefinition.heightCurve = getInt((String) jTable1.getValueAt(7,1));
        speciesDefinition.uniformHeightCurveXML=sdm.initTGFunction(jTable1.getValueAt(8,1).toString());
        speciesDefinition.heightVariationXML=sdm.initTGFunction(jTable1.getValueAt(9,1).toString());
        speciesDefinition.diameterDistributionXML=sdm.initTGFunction(jTable1.getValueAt(10,1).toString());
        speciesDefinition.volumeFunctionXML=sdm.initTGFunction(jTable1.getValueAt(11,1).toString());
        speciesDefinition.stemVolumeFunctionXML=(String) jTable1.getValueAt(12,1);
        speciesDefinition.crownwidthXML=sdm.initTGFunction(jTable1.getValueAt(13,1).toString());
        speciesDefinition.crownbaseXML=sdm.initTGFunction(jTable1.getValueAt(14,1).toString());
        speciesDefinition.crownType = getInt((String) jTable1.getValueAt(15,1));
        speciesDefinition.siteindexXML=sdm.initTGFunction(jTable1.getValueAt(16,1).toString());
        speciesDefinition.siteindexHeightXML=sdm.initTGFunction(jTable1.getValueAt(17,1).toString());
        speciesDefinition.potentialHeightIncrementXML=sdm.initTGFunction(jTable1.getValueAt(18,1).toString());
        speciesDefinition.heightIncrementXML=sdm.initTGFunction(jTable1.getValueAt(19,1).toString());
        speciesDefinition.heightIncrementError = getDouble((String) jTable1.getValueAt(20,1));
        speciesDefinition.diameterIncrementXML=sdm.initTGFunction(jTable1.getValueAt(21,1).toString());
        speciesDefinition.diameterIncrementError = getDouble((String) jTable1.getValueAt(22,1));
        speciesDefinition.maximumDensityXML = sdm.initTGFunction(jTable1.getValueAt(23,1).toString());
        speciesDefinition.maximumAge = getInt((String) jTable1.getValueAt(24,1));
        speciesDefinition.ingrowthXML = (String) jTable1.getValueAt(25,1);
        speciesDefinition.decayXML = sdm.initTGFunction(jTable1.getValueAt(26,1).toString());
        speciesDefinition.cropTreeNumber = getInt((String) jTable1.getValueAt(37,1));
        speciesDefinition.targetDiameter = getDouble((String) jTable1.getValueAt(27,1));
        speciesDefinition.heightOfThinningStart = getDouble((String) jTable1.getValueAt(28,1));
        speciesDefinition.moderateThinning = new HeightBasedThinning((String) jTable1.getValueAt(29,1));
        speciesDefinition.colorXML = (String) jTable1.getValueAt(30,1);
        speciesDefinition.competitionXML = (String) jTable1.getValueAt(31,1);
        speciesDefinition.taperFunctionXML = (String) jTable1.getValueAt(32,1);
        speciesDefinition.coarseRootBiomass = (String) jTable1.getValueAt(33,1);
        speciesDefinition.smallRootBiomass = (String) jTable1.getValueAt(34,1);
        speciesDefinition.fineRootBiomass = (String) jTable1.getValueAt(35,1);
        speciesDefinition.totalRootBiomass = (String) jTable1.getValueAt(36,1);
    }
    
    private int getInt(String s) {
        int i = -9;
        try {
            i = Integer.parseInt(s);
        } catch (NumberFormatException e) {
            logger.log(Level.FINE, "Could not parse number.", e);
        }
        return i;
    }

    private double getDouble(String s) {
        double d = -9;
        try {
            d = Double.parseDouble(s);
        } catch (NumberFormatException e) {
            logger.log(Level.FINE, "Could not parse number.", e);
        }
        return d;
    }
    
    private void loadXMLFile() {
        SpeciesDefMap sdm = new SpeciesDefMap();
        spd.clear();
        try {
            SAXBuilder builder = new SAXBuilder();
            Document doc = builder.build(urlname);
            Element sortimente = doc.getRootElement();
            List<Element> Sortiment = sortimente.getChildren("SpeciesDefinition");
            for (Element sortiment : Sortiment) {
                SpeciesDef speciesDefinition = new SpeciesDef();
                speciesDefinition.code = Integer.parseInt(sortiment.getChild("Code").getText());
                speciesDefinition.internalCode = Integer.parseInt(sortiment.getChild("InternalCode").getText());
                speciesDefinition.shortName = sortiment.getChild("ShortName").getText();
                speciesDefinition.longName = sortiment.getChild("LongName").getText();
                speciesDefinition.latinName = sortiment.getChild("LatinName").getText();
                speciesDefinition.codeGroup = Integer.parseInt(sortiment.getChild("CodeGroup").getText());
                speciesDefinition.handledLikeCode = Integer.parseInt(sortiment.getChild("HandledLikeCode").getText());
                String temp = sortiment.getChild("HeightCurve").getText();
                int ix = Integer.parseInt(temp);
                speciesDefinition.heightCurve = ix;
                speciesDefinition.uniformHeightCurveXML = sdm.initTGFunction(sortiment.getChild("UniformHeightCurveXML").getText());
                speciesDefinition.heightVariationXML = sdm.initTGFunction(sortiment.getChild("HeightVariation").getText());
                speciesDefinition.diameterDistributionXML = sdm.initTGFunction(sortiment.getChild("DiameterDistributionXML").getText());
                speciesDefinition.volumeFunctionXML = sdm.initTGFunction(sortiment.getChild("VolumeFunctionXML").getText());
                speciesDefinition.crownwidthXML = sdm.initTGFunction(sortiment.getChild("Crownwidth").getText());
                speciesDefinition.crownbaseXML = sdm.initTGFunction(sortiment.getChild("Crownbase").getText());
                speciesDefinition.crownType = Integer.parseInt(sortiment.getChild("CrownType").getText());
                try {
                    speciesDefinition.cropTreeNumber = stripCommentsFromInt(sortiment.getChild("CropTreeNumber").getText(), 100);
                } catch (Exception e) {
                    speciesDefinition.cropTreeNumber = 100;
                    logger.log(Level.INFO, "Number of crop trees ist nicht definiert, benutze: " + speciesDefinition.cropTreeNumber, e);
                }

                speciesDefinition.siteindexXML = sdm.initTGFunction(sortiment.getChild("SiteIndex").getText());
                speciesDefinition.siteindexHeightXML = sdm.initTGFunction(sortiment.getChild("SiteIndexHeight").getText());
                speciesDefinition.potentialHeightIncrementXML = sdm.initTGFunction(sortiment.getChild("PotentialHeightIncrement").getText());
                speciesDefinition.heightIncrementXML = sdm.initTGFunction(sortiment.getChild("HeightIncrement").getText());
                speciesDefinition.heightIncrementError = Double.parseDouble(sortiment.getChild("HeightIncrementError").getText());
                speciesDefinition.diameterIncrementXML = sdm.initTGFunction(sortiment.getChild("DiameterIncrement").getText());
                speciesDefinition.diameterIncrementError = Double.parseDouble(sortiment.getChild("DiameterIncrementError").getText());
                speciesDefinition.maximumDensityXML = sdm.initTGFunction(sortiment.getChild("MaximumDensity").getText());
                speciesDefinition.maximumAge = Integer.parseInt(sortiment.getChild("MaximumAge").getText());
                speciesDefinition.ingrowthXML = sortiment.getChild("Ingrowth").getText();
                speciesDefinition.decayXML = sdm.initTGFunction(sortiment.getChild("Decay").getText());
                speciesDefinition.targetDiameter = Double.parseDouble(sortiment.getChild("TargetDiameter").getText());
                speciesDefinition.heightOfThinningStart = Double.parseDouble(sortiment.getChild("HeightOfThinningStart").getText());
                speciesDefinition.moderateThinning = new HeightBasedThinning(sortiment.getChild("ModerateThinning").getText());
                speciesDefinition.colorXML = sortiment.getChild("Color").getText();
                speciesDefinition.competitionXML = sortiment.getChild("Competition").getText();
                speciesDefinition.taperFunctionXML = sortiment.getChild("TaperFunction").getText();
                try {
                    speciesDefinition.stemVolumeFunctionXML = sortiment.getChild("StemVolumeFunction").getText();
                } catch (Exception e) {
                    logger.log(Level.INFO, "Schaftholz ist nicht definiert.", e);
                }
                speciesDefinition.coarseRootBiomass = sortiment.getChild("CoarseRootBiomass").getText();
                speciesDefinition.smallRootBiomass = sortiment.getChild("SmallRootBiomass").getText();
                speciesDefinition.fineRootBiomass = sortiment.getChild("FineRootBiomass").getText();
                speciesDefinition.totalRootBiomass = sortiment.getChild("TotalRootBiomass").getText();

                spd.add(speciesDefinition);
            }

            Element einstellung = doc.getRootElement();
            List<Element> einstellungen = einstellung.getChildren("GeneralSettings");

            // load the first set of GeneralSettings
            for (Element eingestellt : einstellungen) {
                modelRegionTextField.setText(eingestellt.getChild("ModelRegion").getText());
                randomnessCheckBox.setSelected(Boolean.parseBoolean(eingestellt.getChild("ErrorComponent").getText()));
                ingrowthCheckBox.setSelected(Boolean.parseBoolean(eingestellt.getChild("IngrowthModul").getText()));
                deadWoodModuleCheckBox.setSelected(Boolean.parseBoolean(eingestellt.getChild("DeadwoodModul").getText()));
                timeStepTextField.setText(getChildTextOf(eingestellt, "TimeStep", "5"));
                authorTextField.setText(getChildTextOf(eingestellt, "Author", "add author"));
                dateTextField.setText(getChildTextOf(eingestellt, "FirstDate", "add date"));
                lastUpdateTextField.setText(getChildTextOf(eingestellt, "LastChange", "add date"));
                literatureTextField.setText(getChildTextOf(eingestellt, "Literature", "add literature"));
                descriptionTextArea.setText(getChildTextOf(eingestellt, "Description", "add model info"));
                sortingModuleTextField.setText(getChildTextOf(eingestellt, "SortingModul", "none"));
                biomassTextField.setText(getChildTextOf(eingestellt, "BiomassModul", "none"));
                deadWoodModuleTextField.setText(getChildTextOf(eingestellt, "DebriswoodModul", "none"));
                break;
            }
        } catch (IOException | NumberFormatException | JDOMException e) {
            logger.log(Level.SEVERE, "Problem loading settings.", e);
        }
        renewList();
    }

    private String getChildTextOf(Element eingestellt, String childName, String defaultValue) {
        Element ts = eingestellt.getChild(childName);
        if (ts == null) {
            return defaultValue;
        }
        return ts.getText();
    }
    
    private void saveXMLFile(){
       NumberFormat f = NumberFormat.getInstance(new Locale("en","US"));
       f.setMaximumFractionDigits(2);
       f.setMinimumFractionDigits(2);
       Document doc = new Document();
       rootElt = new Element("ForestSimulatorSettings");
       ProcessingInstruction pi = new ProcessingInstruction("xml-stylesheet",
                 "type=\"text/xsl\" href=\"ForestSimulatorSettings.xsl\"");
       doc.addContent(pi);
       doc.setRootElement(rootElt);
       Element elt = new Element("GeneralSettings");
       elt = addString(elt, "ModelRegion", modelRegionTextField.getText());
       elt = addString(elt, "ErrorComponent", String.valueOf(randomnessCheckBox.isSelected()));
       elt = addString(elt, "IngrowthModul", String.valueOf(ingrowthCheckBox.isSelected()));
       elt = addString(elt, "DeadwoodModul", String.valueOf(deadWoodModuleCheckBox.isSelected()));
       elt = addString(elt, "TimeStep", String.valueOf(Integer.parseInt(timeStepTextField.getText().trim())));
       elt = addString(elt, "Author", authorTextField.getText());
       elt = addString(elt, "FirstDate", dateTextField.getText());
       elt = addString(elt, "LastChange", lastUpdateTextField.getText());
       elt = addString(elt, "Literature", literatureTextField.getText());
       elt = addString(elt, "Description", descriptionTextArea.getText());
       elt = addString(elt, "SortingModul", sortingModuleTextField.getText());
       elt = addString(elt, "BiomassModul", biomassTextField.getText());
       elt = addString(elt, "DebriswoodModul", deadWoodModuleTextField.getText());
       rootElt.addContent(elt);
 
       for (SpeciesDef speciesDefinition : spd) {
            elt = new Element("SpeciesDefinition");
            elt = addString(elt, "Code", Integer.toString(speciesDefinition.code));
            elt = addString(elt, "ShortName",speciesDefinition.shortName);
            elt = addString(elt, "LongName",speciesDefinition.longName);
            elt = addString(elt, "LatinName",speciesDefinition.latinName);
            elt = addString(elt, "InternalCode", Integer.toString(speciesDefinition.internalCode));
            elt = addString(elt, "CodeGroup", Integer.toString(speciesDefinition.codeGroup));
            elt = addString(elt, "HandledLikeCode", Integer.toString(speciesDefinition.handledLikeCode));
            elt = addString(elt, "HeightCurve", Integer.toString(speciesDefinition.heightCurve));
            elt = addString(elt, "UniformHeightCurveXML",speciesDefinition.uniformHeightCurveXML.toString());
            elt = addString(elt, "HeightVariation",speciesDefinition.heightVariationXML.toString());
            elt = addString(elt, "DiameterDistributionXML",speciesDefinition.diameterDistributionXML.toString());
            elt = addString(elt, "VolumeFunctionXML",speciesDefinition.volumeFunctionXML.toString());
            elt = addString(elt, "StemVolumeFunction",speciesDefinition.stemVolumeFunctionXML);
            elt = addString(elt, "Crownwidth",speciesDefinition.crownwidthXML.toString());
            elt = addString(elt, "Crownbase",speciesDefinition.crownbaseXML.toString());
            elt = addString(elt, "CrownType", Integer.toString(speciesDefinition.crownType));
            elt = addString(elt, "SiteIndex",speciesDefinition.siteindexXML.toString());
            elt = addString(elt, "SiteIndexHeight",speciesDefinition.siteindexHeightXML.toString());
            elt = addString(elt, "PotentialHeightIncrement",speciesDefinition.potentialHeightIncrementXML.toString());
            elt = addString(elt, "HeightIncrement",speciesDefinition.heightIncrementXML.toString());
            elt = addString(elt, "HeightIncrementError", Double.toString(speciesDefinition.heightIncrementError));
            elt = addString(elt, "DiameterIncrement",speciesDefinition.diameterIncrementXML.toString());
            elt = addString(elt, "DiameterIncrementError", Double.toString(speciesDefinition.diameterIncrementError));
            elt = addString(elt, "MaximumDensity", speciesDefinition.maximumDensityXML.toString());
            elt = addString(elt, "CropTreeNumber", Integer.toString(speciesDefinition.cropTreeNumber));
            elt = addString(elt, "MaximumAge", Integer.toString(speciesDefinition.maximumAge));
            elt = addString(elt, "Ingrowth", speciesDefinition.ingrowthXML);
            elt = addString(elt, "Decay",speciesDefinition.decayXML.toString());
            elt = addString(elt, "TargetDiameter", Double.toString(speciesDefinition.targetDiameter));
            elt = addString(elt, "HeightOfThinningStart", Double.toString(speciesDefinition.heightOfThinningStart));
            elt = addString(elt, "ModerateThinning", speciesDefinition.moderateThinning.definition());
            elt = addString(elt, "Color",speciesDefinition.colorXML);
            elt = addString(elt, "Competition",speciesDefinition.competitionXML);
            elt = addString(elt, "TaperFunction",speciesDefinition.taperFunctionXML);
            elt = addString(elt, "CoarseRootBiomass",speciesDefinition.coarseRootBiomass);
            elt = addString(elt, "SmallRootBiomass",speciesDefinition.smallRootBiomass);
            elt = addString(elt, "FineRootBiomass",speciesDefinition.fineRootBiomass);
            elt = addString(elt, "TotalRootBiomass",speciesDefinition.totalRootBiomass);
            rootElt.addContent(elt);
        }
        try (FileOutputStream result = new FileOutputStream(urlname)) {
            XMLOutputter outputter = new XMLOutputter();
            outputter.setFormat(Format.getPrettyFormat());
            outputter.output(doc, result);
        } catch (IOException e) {
            logger.log(Level.SEVERE, "Saving settings XML failed.", e);
        }
    }

    Element addString(Element elt, String variable, String text) {
        Element var = new Element(variable);
        var.addContent(text);
        elt.addContent(var);
        return elt;
    }

    private void loadTable(SpeciesDef speciesDefinition){
        jTable1.setValueAt("Baumarten Code (I) ",0,0);
        jTable1.setValueAt("Kurzname ",1,0);
        jTable1.setValueAt("Name ",2,0);
        jTable1.setValueAt("lateinisch ",3,0);
        jTable1.setValueAt("Interner Code (I) ",4,0);
        jTable1.setValueAt("Gruppen Code (I) ",5,0);
        jTable1.setValueAt("Einstellungen wie Code (I) ",6,0);
        jTable1.setValueAt("Height Curve (I)",7,0);
        jTable1.setValueAt("Uniform Height Curve ",8,0);
        jTable1.setValueAt("Height Variation",9,0);
        jTable1.setValueAt("Diameter distribution",10,0);
        jTable1.setValueAt("Volume Function o.B.",11,0);
        jTable1.setValueAt("Stem Volume Function o.B.",12,0);
        jTable1.setValueAt("Crown width",13,0);
        jTable1.setValueAt("Crown base",14,0);
        jTable1.setValueAt("Crown type",15,0);
        jTable1.setValueAt("Site index",16,0);
        jTable1.setValueAt("Index height",17,0);
        jTable1.setValueAt("Potential height increment",18,0);
        jTable1.setValueAt("Height Increment",19,0);
        jTable1.setValueAt("Height Increment Error",20,0);
        jTable1.setValueAt("Quadratic Diameter Increment",21,0);
        jTable1.setValueAt("Diameter Increment Error",22,0);
        jTable1.setValueAt("Maximum Density",23,0);
        jTable1.setValueAt("Maximum Age",24,0);
        jTable1.setValueAt("Plugin Ingrowth",25,0);
        jTable1.setValueAt("Decay",26,0);
        jTable1.setValueAt("Target Diameter",27,0);
        jTable1.setValueAt("Height of first Thinning",28,0);
        jTable1.setValueAt("Moderate Thinning Factor",29,0);
        jTable1.setValueAt("Color",30,0);
        jTable1.setValueAt("Plugin Competition",31,0);
        jTable1.setValueAt("Plugin Taper Fuction",32,0);
        jTable1.setValueAt("Grobwurzelbiomasse Funktion",33,0);
        jTable1.setValueAt("Kleinwurzelbiomasse Funktion",34,0);
        jTable1.setValueAt("Feinwurzelbiomasse Funktion",35,0);
        jTable1.setValueAt("Gesamtwurzelbiomasse Funktion",36,0);
        jTable1.setValueAt("Anzahl der Z-Bäume",37,0);
        jTable1.setValueAt(Integer.toString(speciesDefinition.code),0,1);
        jTable1.setValueAt(speciesDefinition.shortName,1,1);
        jTable1.setValueAt(speciesDefinition.longName,2,1);
        jTable1.setValueAt(speciesDefinition.latinName,3,1);
        jTable1.setValueAt(Integer.toString(speciesDefinition.internalCode),4,1);
        jTable1.setValueAt(Integer.toString(speciesDefinition.codeGroup),5,1);
        jTable1.setValueAt(Integer.toString(speciesDefinition.handledLikeCode),6,1);
        jTable1.setValueAt(Integer.toString(speciesDefinition.heightCurve),7,1);
        jTable1.setValueAt(speciesDefinition.uniformHeightCurveXML,8,1);
        jTable1.setValueAt(speciesDefinition.heightVariationXML,9,1);
        jTable1.setValueAt(speciesDefinition.diameterDistributionXML,10,1);
        jTable1.setValueAt(speciesDefinition.volumeFunctionXML,11,1);
        jTable1.setValueAt(speciesDefinition.stemVolumeFunctionXML,12,1);
        jTable1.setValueAt(speciesDefinition.crownwidthXML,13,1);
        jTable1.setValueAt(speciesDefinition.crownbaseXML,14,1);
        jTable1.setValueAt(Integer.toString(speciesDefinition.crownType),15,1);
        jTable1.setValueAt(speciesDefinition.siteindexXML,16,1);
        jTable1.setValueAt(speciesDefinition.siteindexHeightXML,17,1);
        jTable1.setValueAt(speciesDefinition.potentialHeightIncrementXML,18,1);
        jTable1.setValueAt(speciesDefinition.heightIncrementXML,19,1);
        jTable1.setValueAt(Double.toString(speciesDefinition.heightIncrementError),20,1);
        jTable1.setValueAt(speciesDefinition.diameterIncrementXML,21,1);
        jTable1.setValueAt(Double.toString(speciesDefinition.diameterIncrementError),22,1);
        jTable1.setValueAt(speciesDefinition.maximumDensityXML,23,1);
        jTable1.setValueAt(Integer.toString(speciesDefinition.maximumAge),24,1);
        jTable1.setValueAt(speciesDefinition.ingrowthXML,25,1);
        jTable1.setValueAt(speciesDefinition.decayXML,26,1);
        jTable1.setValueAt(Double.toString(speciesDefinition.targetDiameter),27,1);
        jTable1.setValueAt(Double.toString(speciesDefinition.heightOfThinningStart),28,1);
        jTable1.setValueAt(speciesDefinition.moderateThinning,29,1);
        jTable1.setValueAt(speciesDefinition.colorXML,30,1);
        jTable1.setValueAt(speciesDefinition.competitionXML,31,1);
        jTable1.setValueAt(speciesDefinition.taperFunctionXML,32,1);
        jTable1.setValueAt(speciesDefinition.coarseRootBiomass,33,1);
        jTable1.setValueAt(speciesDefinition.smallRootBiomass,34,1);
        jTable1.setValueAt(speciesDefinition.fineRootBiomass,35,1);
        jTable1.setValueAt(speciesDefinition.totalRootBiomass,36,1);
        jTable1.setValueAt(Integer.toString(speciesDefinition.cropTreeNumber),37,1);
    }    
     
    private int stripCommentsFromInt(String orig, int stdValue){
        if(orig==null || orig.equals(""))
            return stdValue;       
        return Integer.parseInt(orig.split("[/][*].+?[*][/]")[0].trim());
    }
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTextField authorTextField;
    private javax.swing.JLabel biomassLabel;
    private javax.swing.JTextField biomassTextField;
    private javax.swing.JLabel dateLabel;
    private javax.swing.JTextField dateTextField;
    private javax.swing.JCheckBox deadWoodModuleCheckBox;
    private javax.swing.JLabel deadWoodModuleLabel;
    private javax.swing.JTextField deadWoodModuleTextField;
    private javax.swing.JButton deleteButton;
    private javax.swing.JTextArea descriptionTextArea;
    private javax.swing.JLabel generalSettingsLabel;
    private javax.swing.JCheckBox ingrowthCheckBox;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JPanel jPanel6;
    private javax.swing.JPanel jPanel7;
    private javax.swing.JPanel jPanel8;
    private javax.swing.JPanel jPanel9;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JScrollPane jScrollPane4;
    private javax.swing.JTable jTable1;
    private javax.swing.JLabel lastUpdateLabel;
    private javax.swing.JTextField lastUpdateTextField;
    private javax.swing.JTextField literatureTextField;
    private javax.swing.JLabel modelRegionLabel;
    private javax.swing.JTextField modelRegionTextField;
    private javax.swing.JCheckBox randomnessCheckBox;
    private javax.swing.JButton saveAsNewButton;
    private javax.swing.JButton saveButton;
    private javax.swing.JButton saveSettingsButton;
    private javax.swing.JLabel selectedSpeciesLabel;
    private javax.swing.JLabel sortingModuleLabel;
    private javax.swing.JTextField sortingModuleTextField;
    private javax.swing.JList speciesList;
    private javax.swing.JLabel timeStepLabel;
    private javax.swing.JTextField timeStepTextField;
    private javax.swing.JLabel treeSpeciesLabel;
    // End of variables declaration//GEN-END:variables
    
}
